package uwu.flauxy.module.impl.exploit;

import net.minecraft.network.play.client.C19PacketResourcePackStatus;
import net.minecraft.network.play.server.S01PacketJoinGame;
import net.minecraft.network.play.server.S48PacketResourcePackSend;
import net.minecraft.util.EnumChatFormatting;
import uwu.flauxy.event.Event;
import uwu.flauxy.event.impl.EventReceivePacket;
import uwu.flauxy.module.Category;
import uwu.flauxy.module.Module;
import uwu.flauxy.module.ModuleInfo;
import uwu.flauxy.utils.PacketUtil;
import uwu.flauxy.utils.Wrapper;

import java.io.UnsupportedEncodingException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;

@ModuleInfo(name = "PackExploit", displayName = "Resource Pack Exploit Fix", cat = Category.Exploit, key = -1)
public class ResourcePackExploitFix extends Module {

    @Override
    public void onEvent(Event e) {
        try{
            if(e instanceof EventReceivePacket){
                EventReceivePacket eventReceivePacket = (EventReceivePacket) e;
                if(eventReceivePacket.getPacket() instanceof S48PacketResourcePackSend){
                    S48PacketResourcePackSend packet = eventReceivePacket.getPacket();
                    URI uri = new URI(packet.getURL());
                    String scheme = uri.getScheme();
                    boolean isLevelProtocol = "level".equals(scheme);

                    if (!"http".equals(scheme) && !"https".equals(scheme) && !isLevelProtocol) {
                        PacketUtil.packetNoEvent(new C19PacketResourcePackStatus(packet.getHash(), C19PacketResourcePackStatus.Action.FAILED_DOWNLOAD));
                        throw new URISyntaxException(packet.getURL(), "Wrong protocol");
                    }

                    String url = URLDecoder.decode(packet.getURL().substring("level://".length()), StandardCharsets.UTF_8.toString());
                    if(isLevelProtocol && (url.contains("..") || !url.endsWith("/resources.zip"))) {
                        System.out.println("Stopped server from performing the resource pack exploit");
                        if(mc.thePlayer != null){
                            Wrapper.instance.log(EnumChatFormatting.RED + " Server tried performing resource pack exploit.");
                        }
                        throw new URISyntaxException(url, "Invalid levelstorage resourcepack path");
                    }
                }
            }
        }catch (URISyntaxException ex) {
            throw new RuntimeException(ex);
        } catch (UnsupportedEncodingException ex) {
            throw new RuntimeException(ex);
        }

    }
}
